# 作业票系统（建筑工地作业票管理系统）产品开发需求文档（PRD + 技术需求，供 Cursor 直接规划与开发）

原始需求来源：fileciteturn0file0  
本文在原文基础上补全可落地的开发细节，并对不清晰处给出**默认最合理方案**（可后续调整）。

---

## 0. 给 Cursor 的执行指令（请严格按此产出 Plan 并实现）

1. 先按本文档拆分 **MVP → V1** 两个里程碑，并输出：
   - 功能清单、里程碑、依赖、风险清单
   - 数据库表设计（含索引）、API 列表（含请求/响应示例）、状态机
   - 前端页面路由与组件划分（后台 Web / 小程序）
   - 对接适配层（实名制系统、门禁系统、微信订阅消息、活体/人脸）
2. 优先实现 **MVP（可上线试运行）**：作业票 → 通知 → 小程序学习 → 门禁授权 的闭环。
3. 所有关键动作必须可追溯：谁在什么时间做了什么（审计日志）。
4. 任何涉及门禁“拒绝进入”的逻辑必须可解释：必须返回拒绝原因码。
5. 提供最少可运行的本地开发环境（docker-compose），以及一键初始化数据脚本（含 demo 票、demo 工人、demo 区域、demo 视频）。

---

## 1. 背景与目标

### 1.1 背景
建筑工地安全管理要求提升，传统人工登记作业票与安全教育无法满足效率与可追溯性，需要数字化闭环：作业票 → 班前教育 → 门禁授权 → 出入记录追溯。【14:0†作业票系统需求文档.docx†L9-L23】

### 1.2 产品目标（必须达成）
- 规范施工单位作业票上传流程，实现人员与施工区域精准匹配。【14:0†作业票系统需求文档.docx†L15-L23】
- 通过班前教育视频学习提升安全意识，并记录培训过程。【14:0†作业票系统需求文档.docx†L75-L85】
- 依据培训完成情况**自动授权门禁**，仅允许合格人员进入指定施工区域。【14:0†作业票系统需求文档.docx†L89-L95】
- 实现人员进出施工区域的数字化管理与追溯。【14:0†作业票系统需求文档.docx†L21-L23】

### 1.3 MVP 成功指标（验收口径）
- 作业票创建成功率 ≥ 99%
- 通知发送成功率（微信订阅消息 API 返回成功）≥ 95%
- 班前教育完成率可统计、可追溯（按日/按票/按区域）
- 门禁授权同步延迟：平均 ≤ 60 秒；P95 ≤ 5 分钟（设备在线情况下）
- 门禁拒绝进入的“可解释率”= 100%（必须能给出原因码：未在名单/未完成培训/不在时间窗/区域不匹配/权限未同步等）

---

## 2. 角色与权限（RBAC）

原始角色与职责：【14:0†作业票系统需求文档.docx†L27-L47】

### 2.1 角色定义
- **系统管理员（SysAdmin）**：系统基础数据、项目/工地配置、用户权限、运行监控。
- **施工单位管理员（ContractorAdmin）**：创建/管理作业票、选择人员与区域、查看培训与授权状态、补推通知。
- **作业人员（Worker）**：小程序接收通知、完成班前教育、刷脸进出区域。

### 2.2 权限模型（默认方案）
- 多租户：按“工地/项目（Site）”隔离数据。
- ContractorAdmin 只能操作其所属施工单位（Contractor）下的作业票与人员关系，但可引用实名制系统的人员主数据。
- SysAdmin 可跨项目查看；所有跨租户操作必须记录审计日志。

---

## 3. 核心概念与术语

- **作业票（Work Ticket）**：描述一个施工任务的日期范围、区域、参与人员、培训视频与截止规则。
- **日作业票（Daily Ticket）**：系统把“多日范围”拆成按天的记录，用于“当日培训→当日授权”。【14:0†作业票系统需求文档.docx†L57-L62】
- **施工区域（Work Area）**：与门禁设备/门禁权限组关联的空间范围。
- **班前教育（Pre-job Training）**：视频学习 + 人脸校验 + 防作弊校验。【14:0†作业票系统需求文档.docx†L75-L85】
- **门禁授权（Access Grant）**：对某日、某人、某区域，在指定时间窗内授予“进入权限”。【14:0†作业票系统需求文档.docx†L89-L95】

---

## 4. 业务流程与状态机

> 原文“业务流程概述”未展开。【14:0†作业票系统需求文档.docx†L49-L52】  
> 这里给出可实现的默认流程（MVP）。

### 4.1 端到端流程（MVP）
1. ContractorAdmin 在后台创建“作业票”（选择日期范围、区域、人员、培训视频、截止时间/可进出时间窗）。【14:0†作业票系统需求文档.docx†L67-L92】
2. 系统拆分生成每一天的 Daily Ticket。
3. 系统向相关 Worker 推送小程序通知（含日期范围、区域、视频列表、截止时间）。【14:1†作业票系统需求文档.docx†L25-L35】
4. Worker 需先完成小程序注册/绑定（手机号+身份证验证）。【14:0†作业票系统需求文档.docx†L113-L117】【14:1†作业票系统需求文档.docx†L1-L11】
5. Worker 在小程序打开待学习任务，学习前做人脸验证；学习过程中随机弹窗验证；完成后生成培训记录。【14:0†作业票系统需求文档.docx†L75-L85】
6. 系统检测到当日培训完成 → 生成门禁授权并同步至门禁系统。【14:1†作业票系统需求文档.docx†L69-L77】
7. Worker 在作业票授权时间范围内刷脸进入；超出范围则拒绝。【14:0†作业票系统需求文档.docx†L55-L61】

### 4.2 状态机定义（默认）

#### 4.2.1 Daily Ticket 状态
- `DRAFT`（草稿，仅创建未提交）
- `PUBLISHED`（已发布：通知已触发）
- `IN_PROGRESS`（当日进行中：可培训/可授权）
- `EXPIRED`（已过期：当日结束）
- `CANCELLED`（取消：不应再授权，需撤销权限）

状态流转：
`DRAFT → PUBLISHED → IN_PROGRESS → EXPIRED`  
任意状态可 `→ CANCELLED`（但需要审计理由）

#### 4.2.2 Worker 在某日某票的培训状态
- `NOT_STARTED`
- `IN_LEARNING`
- `WAITING_VERIFY`（随机校验中）
- `COMPLETED`
- `FAILED`（校验失败/作弊判定/超时）

#### 4.2.3 门禁授权状态
- `PENDING_SYNC`（待同步）
- `SYNCED`（已同步）
- `REVOKED`（已撤销）
- `SYNC_FAILED`（同步失败，需重试）

---

## 5. 范围定义

### 5.1 MVP（必须做）
原文核心模块：作业票管理、通知提醒、班前教育、门禁授权、刷脸进出。【14:0†作业票系统需求文档.docx†L53-L61】【14:0†作业票系统需求文档.docx†L65-L95】

- 后台：作业票创建/查询；人员选择（来自实名制系统）；区域选择；培训视频管理；培训完成进度查看；通知重推；授权状态查看。
- 小程序：注册/绑定；待办列表；视频学习；人脸验证；随机校验；学习记录查询。
- 集成：微信订阅消息；第三方活体/人脸校验；门禁系统权限同步（至少一种方式：推送或拉取）。

### 5.2 V1（建议做）
- 出入记录全量回传与报表（按人/区域/作业票）
- 权限异常自动告警（连续同步失败、设备离线）
- 作业票变更的权限补偿（增删人/改区域/改时间窗）
- 支持多个培训视频与合并判定（全部完成/任一完成）
- 导出 Excel、对接 BI
- 对账任务：本系统期望权限 vs 门禁实际权限

---

## 6. 功能需求详述

### 6.1 后台 Web：作业票管理（核心）
原文要求：上传多日施工人员名单与施工区域、批量选择人员、生成每日作业票记录并可查询。【14:0†作业票系统需求文档.docx†L55-L62】【14:0†作业票系统需求文档.docx†L67-L99】

#### 6.1.1 新增作业票
**页面字段（默认）**
- 作业票名称（必填）
- 施工日期范围 `start_date`, `end_date`（必填，含两端）
- 每日授权时间窗（默认：`06:00-20:00`，可配置）
- 培训截止时间（默认：当日 `07:30`）
- 施工区域（支持多选；MVP 可先单选，但数据模型预留多选）
- 人员名单：从“实名制系统人员库”中多选（支持搜索、批量勾选）
- 培训视频：从视频库选择（支持多选，MVP 默认 1 个）
- 通知策略：创建后立即推送 + 每日提醒（默认开启）
- 备注（可选）

**校验规则**
- end_date >= start_date；跨度默认最大 31 天（可配置）
- 至少 1 人、至少 1 区域、至少 1 视频
- 若人员未在小程序注册：仍允许创建票，但后台标记“未绑定”，通知发送会失败/跳过。

**提交后系统行为**
- 拆分生成 Daily Ticket（每日一条）
- 生成待发送通知任务（NotificationJob）
- 为每日生成“计划授权规则”（不立即授权，需培训完成触发）

#### 6.1.2 作业票列表与详情
- 列表筛选：日期（范围）、区域、施工单位、状态、人员姓名/手机号
- 详情页：展示日期范围、区域、人员、视频、截止规则；并按日展示 Daily Ticket 及统计：
  - 应培训人数 / 已完成 / 未完成 / 失败
  - 授权：待同步/已同步/失败/已撤销
- 支持导出：按票导出人员完成情况（V1）

#### 6.1.3 作业票变更（MVP 受限版）
- 允许变更：备注、截止时间、授权时间窗、增加人员（默认允许）
- 不允许或需高级权限：减少人员、改区域、改日期范围（涉及撤权/补权）
- 变更必须记录：变更人、时间、前后值、原因（审计日志）

---

### 6.2 后台 Web：通知提醒模块
原文要求：基于作业票推送小程序通知；包含日期范围、区域、班前教育要求、截止时间；支持未读提醒与重复推送机制，并考虑模板消息限制策略。【14:0†作业票系统需求文档.docx†L65-L72】【14:1†作业票系统需求文档.docx†L25-L56】

#### 6.2.1 通知类型（默认）
- `TICKET_PUBLISHED`：作业票发布即通知（立即）
- `DAILY_REMINDER`：当日提醒（默认 05:30 推送）
- `DEADLINE_SOON`：距离截止 2 小时仍未完成者
- `BIND_REQUIRED`：未绑定用户的引导（后台可复制注册链接/二维码）

#### 6.2.2 去重与重试
- 同一用户同一 Daily Ticket 同一类型通知：24h 内最多 1 条
- 发送失败重试：指数退避（1m/5m/30m/2h），最多 5 次
- “未读”无法从微信精确获取：默认用“用户进入任务页”作为已触达信号

#### 6.2.3 订阅消息默认方案
- 采用小程序**订阅消息**（替代旧模板消息），在用户首次进入/注册时引导授权订阅。
- 消息字段：任务名称、日期、区域、截止时间、入口按钮（跳转到待办页）。

---

### 6.3 小程序：关联注册/登录
原文要求：扫码注册；手机号验证码；身份证号验证；与人员名单比对；生成唯一工人ID。【14:0†作业票系统需求文档.docx†L113-L117】【14:1†作业票系统需求文档.docx†L1-L11】

#### 6.3.1 注册流程（默认增强，兼容原文）
- 首次进入：获取微信 openid/unionid
- 绑定手机号：
  - 默认优先用微信 `getPhoneNumber`（体验更好）
  - 失败或用户拒绝：走短信验证码
- 输入身份证号（默认全号；如现场合规要求，可改成后 6 位）
- 系统在实名制人员库中匹配：
  - 规则：身份证号全匹配优先；否则（姓名+手机号）辅助匹配
- 绑定成功生成 `worker_id`（系统内部唯一），并记录 unionid/openid

#### 6.3.2 失败处理
- 未匹配到实名制人员：提示“未在本工地作业名单中，请联系管理员”
- 同一身份证绑定多个微信：默认允许 1 个活跃绑定；新绑定会使旧绑定失效（后台可解除）

---

### 6.4 小程序：班前教育视频学习
原文要求：视频库；开始学习需人脸识别验证；学习时长监控与防作弊；完成生成培训记录；支持进度与历史查看。【14:0†作业票系统需求文档.docx†L75-L85】【14:1†作业票系统需求文档.docx†L59-L77】

#### 6.4.1 待办列表
- 今日待办：按 Daily Ticket 聚合展示
- 每条显示：区域、截止时间、视频数量、完成状态、是否已授权

#### 6.4.2 学习前校验
- 开始播放前调用 **人脸验证**（活体优先）确保本人学习
- 校验成功后发放一次性 `learning_session_token`（有效期默认 30 分钟）

#### 6.4.3 播放与进度采集（默认方案）
- 视频播放采用小程序原生 video 组件 + 后端进度接口
- 客户端每 10 秒上报一次播放进度（currentTime、duration、buffered）
- 后端判定有效学习时长：必须前进播放，不允许一直拖拽快进（允许少量拖动，默认 ≤ 总时长 5%）
- 防作弊（随机弹窗验证）：
  - 默认：每 3~7 分钟随机弹出一次“请正对摄像头完成活体校验”
  - 校验失败：本次学习 session 置为 FAILED，可重新开始
- 完成判定：
  - 单视频：有效观看 ≥ 95% 且最终播放到尾部（允许 2% 误差）
  - 多视频：默认 **全部完成** 才算当日完成（可配置为“任一完成”）

#### 6.4.4 培训记录
- 记录字段：worker_id、daily_ticket_id、video_id、开始/结束时间、有效观看时长、校验次数与结果、最终状态、设备信息（机型/系统/网络）
- Worker 可在小程序查看历史（按日期）

---

### 6.5 门禁授权模块（与门禁系统对接）
原文要求：与工地门禁系统对接；仅向完成当日班前教育人员授权对应区域门禁；实时更新状态。【14:0†作业票系统需求文档.docx†L89-L95】

#### 6.5.1 授权规则（默认）
- 授权触发：当日培训状态到达 `COMPLETED` 后立即触发
- 授权范围：
  - 区域：Daily Ticket 关联区域（区域→门禁权限组/设备组映射）
  - 时间窗：Daily Ticket 的 `access_start_time ~ access_end_time`
- 撤权触发：
  - Daily Ticket 取消（CANCELLED）
  - 人员从票中移除（V1）
  - 当日结束（EXPIRED）后撤权（默认撤权，避免次日误入）

#### 6.5.2 安全默认：允许“出”，严格控制“进”
- 默认要求门禁系统做到：无权限也应允许离开（若设备支持方向识别）。  
  若设备不支持方向区分，则做“进出都控”，同时提供“紧急放行”能力（SysAdmin，V1）。

#### 6.5.3 门禁对接方式（默认选择：Push 推送）
原文未说明门禁系统型号与接口形式，此处提供可选；默认选最可控方案。

- A. **Push 推送（默认）**：本系统调用门禁系统 API 下发权限（白名单/权限组），并查询同步结果。
- B. Pull 拉取：门禁系统定时拉取本系统的“可通行人员列表”
- C. 文件/数据库交换：兜底方案（不推荐）

MVP 默认实现 A；若现场门禁不支持，则改用 B 并保持同一领域模型。

#### 6.5.4 权限同步一致性
- 同步失败自动重试（指数退避），并在后台告警
- 同步幂等：同一 `access_grant_id` 重复推送应被门禁侧视为更新，不产生重复记录
- 以本系统为主：本系统记录“期望权限”，门禁为“实际权限”；对账任务（V1）

---

### 6.6 刷脸进出模块
原文要求：现有人脸识别门禁系统；在作业票时间范围内可进出，范围外不可。【14:0†作业票系统需求文档.docx†L55-L61】

#### 6.6.1 进出事件采集（默认：MVP+，建议尽早做）
- 门禁设备上报：事件时间、设备ID、人员ID（或人脸库ID）、事件类型（进/出/拒绝）、原因码（如有）、抓拍图（可选）
- 本系统存储并可按作业票/区域/人员追溯（满足“追溯”目标）。【14:0†作业票系统需求文档.docx†L21-L23】

#### 6.6.2 拒绝原因码（必须统一）
- `NOT_IN_TICKET`：不在当日作业票名单
- `TRAINING_INCOMPLETE`：培训未完成
- `OUT_OF_TIME_WINDOW`：不在授权时间窗
- `AREA_NOT_ALLOWED`：区域不匹配
- `SYNC_PENDING`：培训已完成但权限尚未同步
- `IDENTITY_NOT_BOUND`：人员未完成绑定
- `DEVICE_ERROR`：设备异常/网络异常

---

### 6.7 后台：培训视频维护
原文要求：后台新增视频，录入标题并上传视频文件，供作业票选择。【14:1†作业票系统需求文档.docx†L81-L105】

#### 6.7.1 视频存储默认方案
- 视频文件存储到对象存储（MinIO/OSS），后端存元数据与播放 URL
- 支持转码（V1）：统一分辨率与码率
- 权限控制：播放 URL 使用短期签名（V1）

---

### 6.8 后台：施工区域与门禁映射（补齐必需能力，默认 SysAdmin 管）
> 原文未写，但没有区域与门禁映射，授权无法落地，因此作为“必需基础模块”。

#### 6.8.1 区域管理
- 新增/编辑区域：区域名称、所属工地、描述、关联门禁权限组ID（或设备组ID）、可用状态
- 映射规则：一个区域可关联多个门禁设备（同一权限组）

#### 6.8.2 设备与权限组
- MVP 可只存 “权限组ID” 与 “门禁系统里的组名”
- V1 扩展：设备清单、在线状态、最近心跳、固件版本

---

### 6.9 实名制系统对接（补齐必需能力）
原文提到“上传人员名单（实名制系统选择）”。【14:0†作业票系统需求文档.docx†L83-L86】

默认假设：现场已有“实名制人员库”，本系统不重复造人事系统，只做引用与绑定。

#### 6.9.1 对接目标
- 拉取/查询人员清单（姓名、身份证、手机号、所属施工单位、工种/班组等）
- 获取可用于人脸/门禁的标识：
  - `face_id`（门禁系统的人脸库ID）或
  - `photo_url`（可用来注册到门禁/人脸服务的照片）

#### 6.9.2 默认接口（示例，实际以现场为准）
- `GET /integration/realname/workers?keyword=&page=&page_size=`
- `GET /integration/realname/workers/{id_no}`

失败策略：
- 实名制系统不可用：后台允许继续创建作业票（基于缓存/历史快照），但提示提醒“人员库同步失败”。

---

## 7. 系统设计（建议技术架构，Cursor 可据此落地）

### 7.1 逻辑架构
- Admin Web（React/Vue） → Backend API
- WeChat 小程序 → Backend API
- Backend（单体优先，便于 MVP）：
  - Ticket Service（作业票/日票）
  - Training Service（学习会话/进度/反作弊）
  - Notification Service（订阅消息调度）
  - Access Control Adapter（门禁对接适配层）
  - Realname Adapter（实名制系统对接）
  - Face Verify Adapter（活体/人脸验证）
- 数据库：PostgreSQL（推荐）/ MySQL
- 缓存与队列：Redis（任务队列/分布式锁/去重）
- 对象存储：MinIO（私有化）或云 OSS

### 7.2 关键设计原则
- 所有外部对接都走 Adapter 接口，避免把厂商逻辑写死在业务里。
- 关键动作事件化：TicketPublished、TrainingCompleted、AccessGranted、AccessSyncFailed 等，便于审计与补偿。
- 幂等优先：通知发送、授权推送、学习完成回调等都必须幂等（支持重放）。

### 7.3 后台任务（Scheduler Jobs，默认）
- 每日 00:05：把当天 Daily Ticket 状态切到 `IN_PROGRESS`
- 05:30：发送 `DAILY_REMINDER`
- 每 1 分钟：扫描 `PENDING_SYNC/SYNC_FAILED` 的授权并重试
- 每 10 分钟：健康检查与告警聚合
- 每日 23:59：把当天 Daily Ticket 状态切到 `EXPIRED` 并撤权（默认开启）

---

## 8. 数据模型（MVP 必备，字段级建议）

> 字段可按技术栈调整；关键在于实体与关系。所有表默认包含：`id`（UUID/雪花ID）、`created_at`、`updated_at`、`deleted_at`（软删可选）。

### 8.1 核心表与关键字段
#### 8.1.1 worker（作业人员）
- `worker_id`（PK）
- `name`
- `id_no`（身份证号，唯一）
- `phone`
- `contractor_id`（所属施工单位，可为空）
- `wechat_unionid` / `wechat_openid`
- `face_id`（门禁/人脸库标识，可为空）
- `status`（ACTIVE/INACTIVE）

#### 8.1.2 work_area（施工区域）
- `area_id`
- `site_id`
- `name`
- `access_group_id`（门禁系统权限组ID）
- `status`

#### 8.1.3 training_video（培训视频）
- `video_id`
- `title`
- `file_url`
- `duration_sec`（可由上传后自动分析填充，V1）
- `status`

#### 8.1.4 work_ticket（作业票）
- `ticket_id`
- `site_id`
- `contractor_id`
- `title`
- `start_date` / `end_date`
- `default_access_start_time` / `default_access_end_time`
- `default_training_deadline_time`
- `status`（ACTIVE/CANCELLED）
- `created_by`

关系表：
- `work_ticket_area(ticket_id, area_id)`
- `work_ticket_video(ticket_id, video_id)`
- `work_ticket_worker(ticket_id, worker_id)`（若票级别需要）

#### 8.1.5 daily_ticket（日作业票）
- `daily_ticket_id`
- `ticket_id`
- `date`
- `access_start_time` / `access_end_time`
- `training_deadline_time`
- `status`（DRAFT/PUBLISHED/IN_PROGRESS/EXPIRED/CANCELLED）

#### 8.1.6 daily_ticket_worker（日票-人员状态）
- `daily_ticket_id`
- `worker_id`
- `training_status`
- `authorized`（bool）
- `last_notify_at`
- 组合唯一：`(daily_ticket_id, worker_id)`

#### 8.1.7 training_session（学习会话）
- `session_id`
- `daily_ticket_id`
- `worker_id`
- `video_id`
- `status`（IN_LEARNING/FAILED/COMPLETED）
- `session_token`
- `started_at` / `ended_at`
- `random_check_passed_count` / `random_check_failed_count`

#### 8.1.8 training_record（培训记录）
- `record_id`
- `daily_ticket_id`
- `worker_id`
- `video_id`
- `valid_watch_sec`
- `result`（COMPLETED/FAILED）
- `meta`（JSON：设备/网络/校验摘要）

#### 8.1.9 access_grant（门禁授权）
- `grant_id`
- `daily_ticket_id`
- `worker_id`
- `area_id`
- `access_start_at` / `access_end_at`（具体到时间戳）
- `status`（PENDING_SYNC/SYNCED/SYNC_FAILED/REVOKED）
- `last_sync_at`
- 唯一：`(daily_ticket_id, worker_id, area_id)`

---

## 9. API 需求（含请求/响应示例，Cursor 可据此实现）

### 9.1 通用返回格式（默认）
```json
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```

错误示例：
```json
{
  "code": 40012,
  "message": "TRAINING_INCOMPLETE",
  "data": { "daily_ticket_id": "..." }
}
```

### 9.2 鉴权
- Admin Web：JWT（账号密码；V1 可加企业SSO）
- 小程序：微信登录 code 换 openid/unionid；后端签发 `mp_session_token`

### 9.3 后台作业票

#### 9.3.1 创建作业票
`POST /api/admin/work-tickets`

请求：
```json
{
  "title": "1#楼钢筋绑扎",
  "site_id": "site_001",
  "contractor_id": "ctr_001",
  "start_date": "2026-01-10",
  "end_date": "2026-01-12",
  "access_time_window": {"start": "06:00", "end": "20:00"},
  "training_deadline": "07:30",
  "area_ids": ["area_A"],
  "worker_ids": ["w_001", "w_002"],
  "video_ids": ["v_001"],
  "notify_policy": {"publish_now": true, "daily_reminder": true},
  "remark": ""
}
```

响应（ticket_id）：
```json
{ "code": 0, "message": "ok", "data": { "ticket_id": "t_1001" } }
```

#### 9.3.2 查询作业票列表
`GET /api/admin/work-tickets?date_from=2026-01-10&date_to=2026-01-12&status=ACTIVE&keyword=钢筋`

响应（简化）：
```json
{
  "code": 0,
  "data": {
    "items": [
      {"ticket_id":"t_1001","title":"1#楼钢筋绑扎","start_date":"2026-01-10","end_date":"2026-01-12","status":"ACTIVE"}
    ],
    "total": 1
  }
}
```

#### 9.3.3 作业票详情（含每日统计）
`GET /api/admin/work-tickets/{ticket_id}`

返回需包含：
- 票信息
- daily_tickets 列表（每一天：完成统计、授权统计）

---

### 9.4 小程序：注册绑定

#### 9.4.1 绑定身份
`POST /api/mp/bind`

请求：
```json
{
  "mp_code": "wx_login_code",
  "phone": "13800000000",
  "sms_code": "123456",
  "id_no": "3301xxxxxxxxxxxxxx"
}
```

响应：
```json
{ "code": 0, "data": { "worker_id": "w_001" } }
```

失败：
```json
{ "code": 40401, "message": "WORKER_NOT_FOUND_IN_REALNAME" }
```

---

### 9.5 小程序：任务与学习

#### 9.5.1 今日待办
`GET /api/mp/tasks/today`

响应：
```json
{
  "code": 0,
  "data": {
    "date": "2026-01-10",
    "tasks": [
      {
        "daily_ticket_id": "dt_9001",
        "ticket_title": "1#楼钢筋绑扎",
        "areas": [{"area_id":"area_A","name":"1#楼A区"}],
        "deadline": "07:30",
        "videos": [{"video_id":"v_001","title":"高处作业安全"}],
        "training_status": "NOT_STARTED",
        "authorized": false
      }
    ]
  }
}
```

#### 9.5.2 开始学习（触发人脸校验）
`POST /api/mp/training-sessions`

请求：
```json
{
  "daily_ticket_id": "dt_9001",
  "video_id": "v_001",
  "face_verify_token": "token_from_face_provider"
}
```

响应：
```json
{ "code": 0, "data": { "session_id": "s_7001", "session_token": "st_xxx" } }
```

#### 9.5.3 进度上报
`POST /api/mp/training-sessions/{session_id}/progress`

请求：
```json
{
  "session_token": "st_xxx",
  "current_sec": 120,
  "duration_sec": 600,
  "event": "PLAYING"
}
```

响应：
```json
{ "code": 0, "data": { "valid_watch_sec": 110 } }
```

#### 9.5.4 结束并判定
`POST /api/mp/training-sessions/{session_id}/finish`

响应：
```json
{ "code": 0, "data": { "result": "COMPLETED", "authorized": true } }
```

---

### 9.6 门禁对接（适配层）

#### 9.6.1 推送授权
`POST /api/integration/access-control/grants`

请求：
```json
{
  "grant_id": "g_5001",
  "worker": {"id_no":"3301...","name":"张三","face_id":"face_123"},
  "area": {"access_group_id":"acg_01"},
  "access_start_at": "2026-01-10T06:00:00+08:00",
  "access_end_at": "2026-01-10T20:00:00+08:00"
}
```

响应：
```json
{ "code": 0, "data": { "sync_status": "SYNCED", "vendor_ref": "abc" } }
```

#### 9.6.2 门禁事件回传（Webhook）
`POST /api/integration/access-control/events`

请求：
```json
{
  "device_id": "dev_01",
  "event_time": "2026-01-10T08:01:02+08:00",
  "face_id": "face_123",
  "direction": "IN",
  "result": "PASS",
  "reason_code": ""
}
```

---

## 10. 非功能需求（补全 + 默认指标）

原文非功能：小程序私有化、公众号/小程序注册、手机号自动登录、第三方活体/静态人脸/过程校验。【14:1†作业票系统需求文档.docx†L109-L117】

### 10.1 可用性与性能
- 后端 SLA：99.9%（工作日白天）
- 峰值：1 万工人、日活 3 千的工地规模可支撑（MVP 目标）
- 接口响应：P95 < 300ms（不含第三方人脸/门禁调用）

### 10.2 安全与合规（默认）
- PII（身份证、手机号、面部特征）必须加密存储/脱敏展示
- 审计日志不可篡改（至少追加写 + 备份）
- 视频与人脸图片访问需鉴权；生产环境禁止公开 URL
- 数据保留：至少 2 年（可配置）

### 10.3 可观测性
- 关键指标：通知成功率、培训完成率、授权同步延迟、同步失败率、门禁拒绝原因分布
- 告警：门禁同步连续失败、第三方人脸服务不可用、通知失败率升高

---

## 11. 不清晰/多选项点位清单（已给默认选择）

> 你要求“指出不清楚处，并默认选最合理方案”，这里直接给默认答案（后续可改）。

1. **施工区域是否多选？**  
   - 默认：V1 支持多选；MVP 先做单选（数据模型预留多对多）。
2. **作业票跨多天是否需要每天都学习？**  
   - 默认：需要“当日完成当日有效”，每日都要完成（符合“仅向完成当日班前教育人员授权”）。【14:0†作业票系统需求文档.docx†L89-L95】
3. **培训截止时间规则是什么？**  
   - 默认：当日 `07:30` 前完成；超过截止仍可学习但不授权（后台可手动放行，V1）。
4. **视频是否允许快进/倍速？**  
   - 默认：禁止倍速；允许少量拖动（≤5%）用于回看/误触纠正。
5. **门禁授权时间窗缺省值？**  
   - 默认：`06:00-20:00`（可按工地配置默认值）。
6. **门禁对接方式不明确（推/拉/文件）**  
   - 默认：优先 Push 推送；不支持再降级 Pull 拉取。
7. **学习过程“随机弹窗验证”具体做什么？**  
   - 默认：随机活体校验（眨眼/张嘴/点头）或静态人脸对比（厂商能力优先）。
8. **实名制系统字段标准**  
   - 默认主键：身份证号；辅助：姓名+手机号；face_id/照片由实名制或门禁提供，系统存引用。
9. **未注册小程序的人员怎么处理？**  
   - 默认：仍生成作业票；若无法推送则后台标红“未绑定”，管理员可导出/线下通知。
10. **出入记录是否必须做？**  
   - 默认：MVP+（建议尽早做），因为“追溯”是产品目标之一。【14:0†作业票系统需求文档.docx†L21-L23】

---

## 12. 验收清单（MVP）

1. 后台可创建跨多日作业票，系统自动生成每日记录并可查询。【14:0†作业票系统需求文档.docx†L57-L62】
2. 作业票发布后，相关人员收到小程序通知（至少包含日期、区域、截止）。【14:1†作业票系统需求文档.docx†L25-L35】
3. 工人可完成注册绑定并进入待办列表。【14:0†作业票系统需求文档.docx†L113-L117】
4. 学习前做人脸验证，学习中有随机校验，学习完成生成记录。【14:0†作业票系统需求文档.docx†L75-L85】
5. 当日完成培训后，门禁权限被授予对应区域；并可看到同步状态。【14:0†作业票系统需求文档.docx†L89-L95】
6. 未完成培训/超时/不在名单的人，门禁拒绝且后台可追溯原因。【14:0†作业票系统需求文档.docx†L55-L61】

---

## 13. 附：建议的开发里程碑（Cursor 用）

### Milestone A：闭环跑通（MVP）
- 数据模型 + RBAC + 后台作业票创建/查询
- 区域与门禁映射（最小可用）
- 小程序注册绑定 + 今日待办
- 视频学习（进度上报 + 完成判定）+ 人脸校验（可先 mock）
- 权限授予逻辑 + 门禁适配器（可先 stub：只记录同步结果）
- 通知发送（订阅消息）+ 调度重试
- 审计日志 + 基础监控

### Milestone B：可上工地试运行（MVP+ / V1）
- 对接真实人脸服务与门禁服务
- 出入事件回传与追溯报表
- 作业票变更补偿、撤权策略完善
- 对账与告警
