# 开发问题修复记录

本文档记录项目开发过程中遇到的问题、排查过程和修复方案，供后续维护参考。

---

## 目录

1. [区域创建"无法确定工地"问题](#1-区域创建无法确定工地问题)
2. [数据唯一性问题与清理](#2-数据唯一性问题与清理)
3. [422错误排查指南](#3-422错误排查指南)

---

## 1. 区域创建"无法确定工地"问题

**修复日期**: 2026-01-10  
**问题类型**: 多租户隔离逻辑缺陷  
**影响范围**: 区域、视频、工人创建功能

### 问题现象

系统管理员（SysAdmin）在创建区域时报错：
- ❌ "无法确定工地"
- ❌ "操作失败，请重试"

### 根本原因

**多租户隔离逻辑缺陷**：

```python
# 原代码（错误）
site_id = ctx.accessible_sites[0] if ctx.accessible_sites else None
```

- SysAdmin 的 `accessible_sites` 为空列表 `[]`（表示可访问所有工地）
- 空列表时取 `[0]` 失败，导致 `site_id = None`

### 修复方案

**方案1: 前端显式传递 site_id（已采用）**

1. **修改 Pydantic 模型**：添加 `site_id` 必填字段
   ```python
   class AreaCreate(BaseModel):
       site_id: uuid.UUID = Field(...)  # 新增
       name: str = Field(...)
       code: str = Field(...)
   ```

2. **修改 API 逻辑**：使用请求中的 `site_id` 并验证权限
   ```python
   @router.post("")
   async def create_area(request: AreaCreate, ...):
       if not ctx.is_sys_admin and request.site_id not in ctx.accessible_sites:
           return error_response(code=ErrorCode.FORBIDDEN, message="无权访问")
       site_id = request.site_id
   ```

3. **前端添加工地选择器**：在新增对话框添加"所属工地"下拉框

### 受影响的 API

| API | 文件 | 修复状态 |
|-----|------|---------|
| 创建区域 | `areas.py` | ✅ 已修复 |
| 创建视频 | `videos.py` | ✅ 已修复 |
| 创建工人 | `workers.py` | ✅ 已修复 |

---

## 2. 数据唯一性问题与清理

**发现日期**: 2026-01-10  
**问题类型**: 数据完整性问题  
**影响范围**: 工地、施工单位、作业区域

### 问题发现

多个表存在重复数据，原因：
1. 初始化数据脚本重复执行
2. API 层面缺少唯一性验证

### 检查结果

| 实体 | 唯一字段 | 范围 | 检查结果 |
|-----|---------|------|---------|
| 工地(Site) | name | 全局 | ❌ 发现2组重复 |
| 施工单位(Contractor) | name | 同一工地内 | ❌ 发现3组重复 |
| 作业区域(WorkArea) | name, code | 同一工地内 | ❌ 发现10组重复 |
| 培训视频 | title | 同一工地内 | ✅ 无重复 |
| 用户 | username | 全局 | ✅ 无重复 |
| 工人 | phone, id_no | 同一工地内 | ✅ 无重复 |

### 清理方案

**安全清理流程**：
1. 识别重复记录（按创建时间排序）
2. 保留最早的记录
3. 迁移关联数据到保留记录
4. 删除重复记录

**示例脚本**：
```python
# 迁移关联数据
await db.execute(
    update(Worker)
    .where(Worker.contractor_id == duplicate_id)
    .values(contractor_id=keep_id)
)
# 删除重复记录
await db.execute(
    delete(Contractor).where(Contractor.contractor_id == duplicate_id)
)
```

### API 层面预防

在 `create` 和 `update` 接口添加唯一性检查：

```python
# 检查名称唯一性
existing = await db.execute(
    select(Contractor).where(
        Contractor.site_id == site_id,
        Contractor.name == request.name
    )
)
if existing.scalar_one_or_none():
    return error_response(
        code=ErrorCode.VALIDATION_ERROR,
        message="该名称已存在"
    )
```

### 已修复的 API

| API | 检查字段 | 修复状态 |
|-----|---------|---------|
| 工地 create/update | name (全局唯一) | ✅ |
| 施工单位 create/update | name (工地内唯一) | ✅ |
| 作业区域 create/update | name, code (工地内唯一) | ✅ |

---

## 3. 422错误排查指南

**适用场景**: 前端收到 422 Unprocessable Entity 错误

### 常见原因

| 原因 | 示例 | 解决方案 |
|-----|------|---------|
| 参数类型错误 | UUID 格式无效 | 检查 ID 格式 |
| 必填参数缺失 | 缺少 site_id | 添加必填字段 |
| 参数格式错误 | 日期格式不对 | 使用正确格式 |
| 参数值超范围 | page_size=10000 | 限制在合理范围 |

### 排查步骤

#### 步骤1: 定位失败的 API

1. 打开浏览器开发者工具 (`F12` 或 `Cmd+Option+I`)
2. 切换到 **Network** 标签
3. 刷新页面
4. 筛选状态码 422 的请求

#### 步骤2: 分析请求详情

查看失败请求的：
- **Request URL**: 哪个 API 失败
- **Request Payload**: 发送了什么参数
- **Response**: 具体错误信息

```json
// 典型的 422 错误响应
{
  "detail": [
    {
      "loc": ["body", "site_id"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

#### 步骤3: 常见修复

**1. UUID 格式错误**
```javascript
// 错误
params.ticket_id = "invalid-id"
// 正确
params.ticket_id = "550e8400-e29b-41d4-a716-446655440000"
```

**2. 必填参数缺失**
```javascript
// 错误
{ name: "测试", code: "TEST" }
// 正确
{ site_id: "xxx", name: "测试", code: "TEST" }
```

**3. 日期格式错误**
```javascript
// 错误
params.date = "2026/01/10"
// 正确
params.date = "2026-01-10"
```

### 后端常见问题

**参数类型定义错误**：
```python
# 错误：None 不是有效的类型注解
date: None = None

# 正确
date: Optional[date] = None
```

**分页参数限制**：
```python
# 如果 page_size 超过限制会报 422
page_size: int = Field(default=20, ge=1, le=1000)
```

---

## 附录：相关文件修改清单

| 日期 | 文件 | 修改内容 |
|-----|------|---------|
| 2026-01-10 | `backend/app/api/admin/areas.py` | 添加 site_id 参数和唯一性检查 |
| 2026-01-10 | `backend/app/api/admin/videos.py` | 添加 site_id 参数 |
| 2026-01-10 | `backend/app/api/admin/workers.py` | 添加 site_id 参数 |
| 2026-01-10 | `backend/app/api/admin/contractors.py` | 添加唯一性检查和删除接口 |
| 2026-01-10 | `backend/app/api/admin/sites.py` | 添加唯一性检查 |
| 2026-01-10 | `backend/app/api/admin/users.py` | 添加删除接口 |
| 2026-01-10 | `backend/app/api/admin/daily_tickets.py` | 修复 date 参数类型 |
| 2026-01-10 | `admin-web/src/views/areas/index.vue` | 添加工地选择器 |

---

*文档更新时间：2026年1月11日*

