# E2E 自动化测试经验总结（Playwright + Pytest）

本文总结本项目一次“端到端（E2E）业务流”自动化测试的落地经验：从需求到脚本稳定运行，再到可复用的工程化脚手架。目标是让 E2E 成为一种**批量化、自动化、可视化调试友好**的测试手段，而不是“偶尔跑一次的脆弱脚本”。

---

## 1. 我们要解决的核心问题

- **覆盖真实业务路径**：登录 → 创建工地/施工单位/区域/视频/人员 → 创建作业票 → 校验关联关系。
- **避免只测 API 不测前端交互**：很多问题（422、必填字段、UI 组件行为、路由/权限、异步渲染）只会在真实页面操作中暴露。
- **把“可视化调试”和“全自动无人值守”统一起来**：
  - 本地：可视化（headed）+ 慢速（slow-mo）便于排障。
  - CI：无头（headless）+ 稳定等待 + 失败时保存信息便于复现。

---

## 2. 这套方法为什么“宝贵”

E2E 的价值不只是“再跑一遍”，而是：

- **把多人协作的复杂系统（前端 + 后端 + 多租户 + 权限 + 数据依赖）**变成可重复验证的流水线。
- **把线上真实 bug 的复现步骤固化**成代码，变成未来的回归测试。
- **把交互型组件的脆弱点系统性解决**（下拉框、弹窗、日期/时间控件、表格分页、异步刷新）。

---

## 3. 工程化落地：我们在项目里做了什么

### 3.1 关键文件（本仓库）

- `tests/test_e2e_business_workflow.py`
  - 一条完整业务链路的 E2E 测试。
  - 支持环境变量控制可视化与慢速运行：`SHOW_BROWSER`、`SLOW_MO`。
- `scripts/run_e2e_auto.sh`
  - Mac 上全自动运行：检查前后端服务 → 设置环境变量 → 执行 pytest。
- `scripts/run_e2e.sh` / `Makefile`
  - 进一步简化运行命令。
- `tests/README.md`
  - 将 E2E 跑法写清楚，降低新同学上手成本。

---

## 4. 稳定性原则（E2E 成败的关键）

### 4.1 定位器（Locator）优先级：稳定 > “看起来能用”

推荐顺序：

- **优先**：语义定位（`get_by_role` + name）
- **其次**：带稳定属性的选择器（`data-testid` / `aria-label`）
- **兜底**：`text=`、CSS 类（对 UI 调整敏感）

本项目踩过的坑：

- “strict mode violation：text=施工单位 匹配到多个元素”
  - 解决：用 `get_by_role('menuitem', name='施工单位')` 等更精确定位。

### 4.2 等待策略：显式等待可见/可点击，而不是“盲目 sleep”

建议组合：

- `expect(locator).to_be_visible()`
- `expect(locator).to_be_enabled()`
- 等对话框消失：`expect(dialog).to_be_hidden()` 或等待某个确定元素出现

避免：

- 大量固定 `wait_for_timeout`（会慢且仍不稳定）

### 4.3 弹窗“确定按钮”点击：要把范围限定在 dialog 里

典型坑：

- 页面上有多个 “确定/保存/提交” 按钮，默认定位会点错。

我们采用的经验：

- 用 `dialog.locator(...)` 将所有输入与按钮 **限定在弹窗 DOM 范围内**。
- 点击按钮用 footer 主按钮：`.el-dialog__footer button.el-button--primary`

### 4.4 Element Plus 组件交互（下拉框/日期/时间）是 E2E 难点

#### 下拉框（`el-select`）

坑：

- 选择后下拉不自动收起，影响后续点击。

经验：

- 选择后补一个 `keyboard.press("Escape")` 强制收起。
- 等待选项项出现：`.el-select-dropdown__item:visible`
- 选不到指定文本时，兜底选第一项（提升稳定性）

#### 日期范围（`el-date-picker`）

坑：

- 直接 fill 可能被控件拦截。

经验：

- 优先点击快捷项（如“今天-7天”），失败再填输入框。
- 让控件“确认”动作落地：必要时 `Enter` 或点击空白处触发 blur。

#### 时间（`el-time-picker`）

坑：

- 必填但 UI 默认值为空，脚本不填就无法点击“确定”。

经验：

- 明确把必填时间字段填上，并用 `Enter` 使其生效。

---

## 5. 数据校验方式：UI 校验 vs API 校验

UI 校验容易受分页/异步刷新影响；本项目在关键节点采用了更稳的做法：

- **创建后用后端 API 查询验证**（例如按关键字检索），拿到生成的 `id` 继续后续步骤。

收益：

- 少受 UI 表格分页、渲染时序影响。
- 还能把“创建成功但 UI 不显示”的问题区分出来（是 UI 问题还是后端持久化问题）。

---

## 6. 为什么之前的测试没抓到 422？E2E 如何补位

典型原因：

- 单元/接口测试覆盖了接口“功能”，但没覆盖前端“参数拼装”。
- 多租户（`site_id`）这类字段在 UI 中可能来自 store/上下文，容易漏传。

E2E 的补位方式：

- 真实页面点击 + 真实表单填写 → 最容易触发漏传字段（422）
- 一旦遇到 422，把复现路径固化成测试，未来回归自动挡住

---

## 7. 让 E2E “可视化 + 全自动”的推荐跑法

本地调试（可视化）：

```bash
SHOW_BROWSER=true SLOW_MO=500 pytest -q tests/test_e2e_business_workflow.py -s
```

全自动（推荐）：

```bash
./scripts/run_e2e_auto.sh
```

---

## 8. 本次实战的“高频踩坑清单”（直接可复用）

- **placeholder 误判 input/textarea**：地址字段是 `textarea`，脚本却用 `input` 定位。
- **同名输入冲突**：页面搜索框与弹窗输入同 placeholder，必须 scope 到 dialog。
- **按钮文案不一致**：页面是“保存草稿/提交并发布”，不是“确定”。
- **下拉框选完不收起**：按 `Escape` 或提供 UI “收起”按钮。
- **必填时间字段未填导致无法提交**：显式填值并确认生效。
- **验证点选择不当**：UI 文案不稳定时，用 API 断言更可靠。

---

## 9. 下一步建议（把 E2E 变成团队资产）

- **为关键控件补 `data-testid`**（尤其是弹窗“确定/保存”、各模块“新增”按钮、关键输入框），可以显著提升稳定性与维护性。
- **拆分步骤为可复用 helper**：`open_dialog() / fill_form() / submit_dialog() / select_first_option()`，减少重复代码。
- **失败自动采集信息**：截图 + console log + network log（Playwright 原生支持），让排障成本更低。
- **在 CI 中每天/每次合并跑一条 P0 业务流**：把最关键的“主链路”变成回归护栏。

---

## 10. 一句话总结

E2E 的真正价值，是把“真实用户路径上的 bug”变成**可以批量自动回归的程序化资产**；本次我们通过更稳定的定位/等待/控件交互策略，把 E2E 从“容易卡住”提升到“可全自动运行且可视化调试”的状态。


