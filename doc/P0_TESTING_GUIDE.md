# P0 åŠŸèƒ½æµ‹è¯•æŒ‡å—

æœ¬æ–‡æ¡£æä¾›äº† P0 ä¼˜å…ˆçº§åŠŸèƒ½çš„æµ‹è¯•æ­¥éª¤å’ŒéªŒè¯æ–¹æ³•ã€‚

**æµ‹è¯•æ—¥æœŸ**: 2026-01-10

---

## ğŸ§ª æµ‹è¯•ç¯å¢ƒå‡†å¤‡

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate  # Windows

# å¯åŠ¨æœåŠ¡
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd admin-web
npm install
npm run dev
```

### 3. å‡†å¤‡æµ‹è¯•æ•°æ®

ç¡®ä¿æ•°æ®åº“ä¸­æœ‰ä»¥ä¸‹æµ‹è¯•æ•°æ®ï¼š
- è‡³å°‘ä¸€ä¸ªå·¥åœ°ï¼ˆSiteï¼‰
- è‡³å°‘ä¸€ä¸ªæ–½å·¥å•ä½ï¼ˆContractorï¼‰
- è‡³å°‘ä¸€ä¸ªä½œä¸šç¥¨ï¼ˆWorkTicketï¼‰å¤„äº IN_PROGRESS çŠ¶æ€
- è‡³å°‘ä¸€äº›åŸ¹è®­è®°å½•å’Œé—¨ç¦æˆæƒè®°å½•

---

## âœ… æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1: ä½œä¸šç¥¨å…³é—­ API

**åŠŸèƒ½**: å…³é—­ä½œä¸šç¥¨å¹¶æ’¤é”€ç›¸å…³æˆæƒ

**æµ‹è¯•æ­¥éª¤**:

1. **å‰ç«¯æµ‹è¯•**:
   - ç™»å½•ç®¡ç†åå°
   - è¿›å…¥"ä½œä¸šç¥¨ç®¡ç†"é¡µé¢
   - æ‰¾åˆ°ä¸€ä¸ªçŠ¶æ€ä¸º"è¿›è¡Œä¸­"çš„ä½œä¸šç¥¨
   - ç‚¹å‡»"å…³é—­"æŒ‰é’®
   - åœ¨å¼¹å‡ºçš„ç¡®è®¤å¯¹è¯æ¡†ä¸­è¾“å…¥å…³é—­åŸå› 
   - ç‚¹å‡»ç¡®è®¤

2. **åç«¯ API æµ‹è¯•**:
   ```bash
   # ä½¿ç”¨ curl æµ‹è¯•
   curl -X POST "http://localhost:8000/api/admin/work-tickets/{ticket_id}/close" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"reason": "æµ‹è¯•å…³é—­"}'
   ```

**é¢„æœŸç»“æœ**:
- âœ… ä½œä¸šç¥¨çŠ¶æ€å˜æ›´ä¸º "CLOSED"
- âœ… ç›¸å…³çš„æ¯æ—¥ç¥¨æ®çŠ¶æ€å˜æ›´ä¸º "CLOSED"
- âœ… æ‰€æœ‰ç›¸å…³çš„é—¨ç¦æˆæƒè¢«æ’¤é”€
- âœ… è¿”å›æ’¤é”€çš„æˆæƒæ•°é‡
- âœ… è®°å½•å®¡è®¡æ—¥å¿—
- âœ… å‰ç«¯æ˜¾ç¤ºæˆåŠŸæç¤ºæ¶ˆæ¯

**éªŒè¯æ–¹æ³•**:
```sql
-- æ£€æŸ¥ä½œä¸šç¥¨çŠ¶æ€
SELECT ticket_id, title, status FROM work_tickets WHERE ticket_id = 'YOUR_TICKET_ID';

-- æ£€æŸ¥æ¯æ—¥ç¥¨æ®çŠ¶æ€
SELECT daily_ticket_id, date, status FROM daily_tickets WHERE ticket_id = 'YOUR_TICKET_ID';

-- æ£€æŸ¥æˆæƒçŠ¶æ€
SELECT grant_id, status, revoked_at FROM access_grants 
WHERE daily_ticket_id IN (
  SELECT daily_ticket_id FROM daily_tickets WHERE ticket_id = 'YOUR_TICKET_ID'
);

-- æ£€æŸ¥å®¡è®¡æ—¥å¿—
SELECT * FROM audit_logs 
WHERE resource_type = 'WorkTicket' AND resource_id = 'YOUR_TICKET_ID' 
ORDER BY created_at DESC LIMIT 5;
```

---

### æµ‹è¯• 2: å®¡è®¡æ—¥å¿—æŸ¥è¯¢ API

**åŠŸèƒ½**: æŸ¥è¯¢å®¡è®¡æ—¥å¿—ï¼Œæ”¯æŒå¤šç§ç­›é€‰æ¡ä»¶

**æµ‹è¯•æ­¥éª¤**:

1. **å‰ç«¯æµ‹è¯•**:
   - è¿›å…¥ä½œä¸šç¥¨è¯¦æƒ…é¡µ
   - åˆ‡æ¢åˆ°"å˜æ›´å†å²"æ ‡ç­¾
   - æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºäº†è¯¥ä½œä¸šç¥¨çš„æ‰€æœ‰å˜æ›´è®°å½•

2. **åç«¯ API æµ‹è¯•**:
   ```bash
   # æŸ¥è¯¢æ‰€æœ‰å®¡è®¡æ—¥å¿—
   curl "http://localhost:8000/api/admin/audit-logs?page=1&page_size=20" \
     -H "Authorization: Bearer YOUR_TOKEN"
   
   # æŒ‰èµ„æºç±»å‹ç­›é€‰
   curl "http://localhost:8000/api/admin/audit-logs?resource_type=WorkTicket&page=1&page_size=20" \
     -H "Authorization: Bearer YOUR_TOKEN"
   
   # æŒ‰èµ„æºIDç­›é€‰ï¼ˆæŸ¥è¯¢ç‰¹å®šä½œä¸šç¥¨çš„æ—¥å¿—ï¼‰
   curl "http://localhost:8000/api/admin/audit-logs?resource_type=WorkTicket&resource_id={ticket_id}&page=1&page_size=20" \
     -H "Authorization: Bearer YOUR_TOKEN"
   
   # æŒ‰æ“ä½œç±»å‹ç­›é€‰
   curl "http://localhost:8000/api/admin/audit-logs?action=TICKET_CLOSE&page=1&page_size=20" \
     -H "Authorization: Bearer YOUR_TOKEN"
   
   # æŒ‰æ—¶é—´èŒƒå›´ç­›é€‰
   curl "http://localhost:8000/api/admin/audit-logs?start_date=2026-01-01&end_date=2026-01-10&page=1&page_size=20" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

**é¢„æœŸç»“æœ**:
- âœ… è¿”å›ç¬¦åˆç­›é€‰æ¡ä»¶çš„å®¡è®¡æ—¥å¿—åˆ—è¡¨
- âœ… åŒ…å«æ“ä½œäººã€æ“ä½œç±»å‹ã€èµ„æºä¿¡æ¯ã€å˜æ›´å†…å®¹ç­‰
- âœ… æ”¯æŒåˆ†é¡µ
- âœ… å‰ç«¯æ­£ç¡®æ˜¾ç¤ºå˜æ›´å†å²
- âœ… å˜æ›´æè¿°æ¸…æ™°æ˜“æ‡‚

**éªŒè¯å­—æ®µ**:
```json
{
  "code": 0,
  "data": {
    "items": [
      {
        "log_id": "uuid",
        "operator_name": "æ“ä½œäººå§“å",
        "operator_role": "è§’è‰²",
        "action": "TICKET_CLOSE",
        "resource_type": "WorkTicket",
        "resource_id": "uuid",
        "resource_name": "ä½œä¸šç¥¨æ ‡é¢˜",
        "old_value": {},
        "new_value": {"status": "CLOSED", "revoked_grants_count": 5},
        "reason": "å…³é—­åŸå› ",
        "created_at": "2026-01-10T10:00:00"
      }
    ],
    "total": 100,
    "page": 1,
    "page_size": 20
  }
}
```

---

### æµ‹è¯• 3: åŸ¹è®­ç»Ÿè®¡ API

**åŠŸèƒ½**: è·å–åŸ¹è®­å®Œæˆç‡ã€æ—¶é•¿ç­‰ç»Ÿè®¡æ•°æ®

**æµ‹è¯•æ­¥éª¤**:

1. **å‰ç«¯æµ‹è¯•**:
   - è¿›å…¥"æŠ¥è¡¨ä¸­å¿ƒ"é¡µé¢
   - åˆ‡æ¢åˆ°"åŸ¹è®­ç»Ÿè®¡"æ ‡ç­¾
   - é€‰æ‹©æ—¥æœŸèŒƒå›´
   - æŸ¥çœ‹åŸ¹è®­å®Œæˆç‡è¶‹åŠ¿å›¾è¡¨

2. **åç«¯ API æµ‹è¯•**:
   ```bash
   # æŸ¥è¯¢æœ€è¿‘7å¤©çš„åŸ¹è®­ç»Ÿè®¡
   curl "http://localhost:8000/api/admin/reports/training-stats" \
     -H "Authorization: Bearer YOUR_TOKEN"
   
   # æŒ‡å®šæ—¥æœŸèŒƒå›´
   curl "http://localhost:8000/api/admin/reports/training-stats?start_date=2026-01-01&end_date=2026-01-10" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

**é¢„æœŸç»“æœ**:
- âœ… è¿”å›åŸ¹è®­ç»Ÿè®¡æ•°æ®
- âœ… åŒ…å«æ€»äººæ•°ã€å®Œæˆäººæ•°ã€å®Œæˆç‡
- âœ… åŒ…å«å„çŠ¶æ€äººå‘˜æ•°é‡
- âœ… åŒ…å«å¹³å‡åŸ¹è®­æ—¶é•¿
- âœ… åŒ…å«è§†é¢‘å®Œæˆç»Ÿè®¡
- âœ… å‰ç«¯å›¾è¡¨æ­£ç¡®æ˜¾ç¤º

**è¿”å›æ•°æ®ç¤ºä¾‹**:
```json
{
  "code": 0,
  "data": {
    "start_date": "2026-01-03",
    "end_date": "2026-01-10",
    "total_workers": 100,
    "completed_count": 85,
    "in_learning_count": 10,
    "not_started_count": 3,
    "failed_count": 2,
    "completion_rate": 85.0,
    "avg_duration_minutes": 45.5,
    "total_videos_completed": 255,
    "total_videos_required": 300,
    "video_completion_rate": 85.0
  }
}
```

---

### æµ‹è¯• 4: é—¨ç¦åŒæ­¥ç»Ÿè®¡ API

**åŠŸèƒ½**: è·å–é—¨ç¦åŒæ­¥æˆåŠŸç‡ã€å¤±è´¥åŸå› ç­‰ç»Ÿè®¡

**æµ‹è¯•æ­¥éª¤**:

1. **å‰ç«¯æµ‹è¯•**:
   - è¿›å…¥"æŠ¥è¡¨ä¸­å¿ƒ"é¡µé¢
   - åˆ‡æ¢åˆ°"é—¨ç¦åŒæ­¥"æ ‡ç­¾
   - æŸ¥çœ‹åŒæ­¥æˆåŠŸç‡ã€å¤±è´¥æ¬¡æ•°ç­‰ç»Ÿè®¡

2. **åç«¯ API æµ‹è¯•**:
   ```bash
   # æŸ¥è¯¢æœ€è¿‘7å¤©çš„åŒæ­¥ç»Ÿè®¡
   curl "http://localhost:8000/api/admin/reports/access-sync-stats" \
     -H "Authorization: Bearer YOUR_TOKEN"
   
   # æŒ‡å®šæ—¥æœŸèŒƒå›´
   curl "http://localhost:8000/api/admin/reports/access-sync-stats?start_date=2026-01-01&end_date=2026-01-10" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

**é¢„æœŸç»“æœ**:
- âœ… è¿”å›åŒæ­¥ç»Ÿè®¡æ•°æ®
- âœ… åŒ…å«æ€»æ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°
- âœ… åŒ…å«åŒæ­¥æˆåŠŸç‡
- âœ… åŒ…å«å¹³å‡åŒæ­¥æ—¶é•¿
- âœ… åŒ…å«é‡è¯•æ¬¡æ•°ç»Ÿè®¡
- âœ… åŒ…å«å¤±è´¥åŸå› ç»Ÿè®¡ï¼ˆTop 10ï¼‰
- âœ… å‰ç«¯æ­£ç¡®æ˜¾ç¤ºç»Ÿè®¡æ•°æ®

**è¿”å›æ•°æ®ç¤ºä¾‹**:
```json
{
  "code": 0,
  "data": {
    "start_date": "2026-01-03",
    "end_date": "2026-01-10",
    "total_count": 500,
    "synced_count": 485,
    "pending_count": 10,
    "failed_count": 5,
    "revoked_count": 50,
    "sync_rate": 97.0,
    "avg_sync_duration_seconds": 2.5,
    "max_retry_count": 3,
    "avg_retry_count": 1.2,
    "failure_reasons": [
      {"reason": "è®¾å¤‡ç¦»çº¿", "count": 3},
      {"reason": "ç½‘ç»œè¶…æ—¶", "count": 2}
    ]
  }
}
```

---

### æµ‹è¯• 5: æŠ¥è¡¨ä¸­å¿ƒæ•´ä½“åŠŸèƒ½

**åŠŸèƒ½**: éªŒè¯æŠ¥è¡¨ä¸­å¿ƒæ‰€æœ‰ API çš„é›†æˆ

**æµ‹è¯•æ­¥éª¤**:

1. **å‰ç«¯æµ‹è¯•**:
   - è¿›å…¥"æŠ¥è¡¨ä¸­å¿ƒ"é¡µé¢
   - éªŒè¯é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è°ƒç”¨æ‰€æœ‰ API
   - åˆ‡æ¢ä¸åŒçš„æ ‡ç­¾é¡µ
   - ä¿®æ”¹æ—¥æœŸèŒƒå›´
   - éªŒè¯æ•°æ®è‡ªåŠ¨åˆ·æ–°

2. **éªŒè¯ç‚¹**:
   - âœ… åŸ¹è®­ç»Ÿè®¡æ ‡ç­¾æ˜¾ç¤ºæ­£ç¡®æ•°æ®
   - âœ… é—¨ç¦åŒæ­¥æ ‡ç­¾æ˜¾ç¤ºæ­£ç¡®æ•°æ®
   - âœ… å¯¹è´¦æŠ¥å‘Šæ ‡ç­¾æ˜¾ç¤ºæ­£ç¡®æ•°æ®
   - âœ… è¶‹åŠ¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
   - âœ… æ—¥æœŸç­›é€‰åŠŸèƒ½æ­£å¸¸
   - âœ… Tab åˆ‡æ¢æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®

---

### æµ‹è¯• 6: å˜æ›´å†å²åŠŸèƒ½

**åŠŸèƒ½**: éªŒè¯ä½œä¸šç¥¨è¯¦æƒ…é¡µçš„å˜æ›´å†å²

**æµ‹è¯•æ­¥éª¤**:

1. **å‡†å¤‡æµ‹è¯•æ•°æ®**:
   - åˆ›å»ºä¸€ä¸ªä½œä¸šç¥¨
   - ä¿®æ”¹ä½œä¸šç¥¨ï¼ˆæ·»åŠ äººå‘˜ã€ä¿®æ”¹æ—¶é—´ç­‰ï¼‰
   - å‘å¸ƒä½œä¸šç¥¨
   - å…³é—­ä½œä¸šç¥¨

2. **å‰ç«¯æµ‹è¯•**:
   - è¿›å…¥è¯¥ä½œä¸šç¥¨çš„è¯¦æƒ…é¡µ
   - åˆ‡æ¢åˆ°"å˜æ›´å†å²"æ ‡ç­¾
   - éªŒè¯æ˜¾ç¤ºäº†æ‰€æœ‰æ“ä½œè®°å½•

3. **éªŒè¯ç‚¹**:
   - âœ… æ˜¾ç¤ºåˆ›å»ºè®°å½•
   - âœ… æ˜¾ç¤ºä¿®æ”¹è®°å½•ï¼ˆåŒ…å«å˜æ›´å†…å®¹ï¼‰
   - âœ… æ˜¾ç¤ºå‘å¸ƒè®°å½•
   - âœ… æ˜¾ç¤ºå…³é—­è®°å½•ï¼ˆåŒ…å«æ’¤é”€æˆæƒæ•°é‡ï¼‰
   - âœ… æ˜¾ç¤ºæ“ä½œäººå’Œæ“ä½œæ—¶é—´
   - âœ… å˜æ›´æè¿°æ¸…æ™°æ˜“æ‡‚

---

## ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: API è¿”å› 401 æœªæˆæƒ

**åŸå› **: Token è¿‡æœŸæˆ–æ— æ•ˆ

**è§£å†³æ–¹æ³•**:
```bash
# é‡æ–°ç™»å½•è·å–æ–°çš„ Token
curl -X POST "http://localhost:8000/api/admin/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "your_password"}'
```

### é—®é¢˜ 2: å‰ç«¯æ— æ³•è¿æ¥åç«¯

**æ£€æŸ¥æ¸…å•**:
- âœ… åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆæ£€æŸ¥ç«¯å£ 8000ï¼‰
- âœ… å‰ç«¯ API åŸºç¡€è·¯å¾„é…ç½®æ˜¯å¦æ­£ç¡®
- âœ… CORS é…ç½®æ˜¯å¦æ­£ç¡®
- âœ… æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### é—®é¢˜ 3: æ•°æ®ä¸æ˜¾ç¤ºæˆ–æ˜¾ç¤ºä¸ºç©º

**æ£€æŸ¥æ¸…å•**:
- âœ… æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æµ‹è¯•æ•°æ®
- âœ… å¤šç§Ÿæˆ·è¿‡æ»¤æ˜¯å¦æ­£ç¡®
- âœ… æ—¥æœŸèŒƒå›´æ˜¯å¦åŒ…å«æ•°æ®
- âœ… æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ Network æ ‡ç­¾ï¼Œæ£€æŸ¥ API å“åº”

### é—®é¢˜ 4: å…³é—­ä½œä¸šç¥¨åæˆæƒæœªæ’¤é”€

**æ£€æŸ¥æ¸…å•**:
- âœ… æŸ¥çœ‹æ•°æ®åº“ä¸­ access_grants è¡¨çš„ status å­—æ®µ
- âœ… æ£€æŸ¥åç«¯æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
- âœ… éªŒè¯ AccessService.revoke_grant æ–¹æ³•æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### 1. å®¡è®¡æ—¥å¿—æŸ¥è¯¢æ€§èƒ½

```bash
# æµ‹è¯•å¤§é‡æ•°æ®çš„æŸ¥è¯¢æ€§èƒ½
time curl "http://localhost:8000/api/admin/audit-logs?page=1&page_size=100" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é¢„æœŸ**: å“åº”æ—¶é—´ < 500ms

### 2. åŸ¹è®­ç»Ÿè®¡è®¡ç®—æ€§èƒ½

```bash
# æµ‹è¯•é•¿æ—¶é—´èŒƒå›´çš„ç»Ÿè®¡æ€§èƒ½
time curl "http://localhost:8000/api/admin/reports/training-stats?start_date=2026-01-01&end_date=2026-12-31" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é¢„æœŸ**: å“åº”æ—¶é—´ < 2s

### 3. é—¨ç¦åŒæ­¥ç»Ÿè®¡è®¡ç®—æ€§èƒ½

```bash
# æµ‹è¯•å¤§é‡æˆæƒè®°å½•çš„ç»Ÿè®¡æ€§èƒ½
time curl "http://localhost:8000/api/admin/reports/access-sync-stats?start_date=2026-01-01&end_date=2026-12-31" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**é¢„æœŸ**: å“åº”æ—¶é—´ < 2s

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [ ] ä½œä¸šç¥¨å…³é—­åŠŸèƒ½æ­£å¸¸
- [ ] æˆæƒæ’¤é”€åŠŸèƒ½æ­£å¸¸
- [ ] å®¡è®¡æ—¥å¿—è®°å½•æ­£å¸¸
- [ ] å®¡è®¡æ—¥å¿—æŸ¥è¯¢æ­£å¸¸ï¼ˆæ‰€æœ‰ç­›é€‰æ¡ä»¶ï¼‰
- [ ] åŸ¹è®­ç»Ÿè®¡ API æ­£å¸¸
- [ ] é—¨ç¦åŒæ­¥ç»Ÿè®¡ API æ­£å¸¸
- [ ] æŠ¥è¡¨ä¸­å¿ƒé¡µé¢æ­£å¸¸
- [ ] å˜æ›´å†å²æ˜¾ç¤ºæ­£å¸¸

### è¾¹ç•Œæµ‹è¯•
- [ ] å…³é—­å·²å…³é—­çš„ä½œä¸šç¥¨ï¼ˆåº”è¿”å›é”™è¯¯ï¼‰
- [ ] å…³é—­å·²å–æ¶ˆçš„ä½œä¸šç¥¨ï¼ˆåº”è¿”å›é”™è¯¯ï¼‰
- [ ] æŸ¥è¯¢ä¸å­˜åœ¨çš„å®¡è®¡æ—¥å¿—
- [ ] æŸ¥è¯¢ç©ºæ—¥æœŸèŒƒå›´çš„ç»Ÿè®¡
- [ ] æŸ¥è¯¢æœªæ¥æ—¥æœŸçš„ç»Ÿè®¡

### å®‰å…¨æµ‹è¯•
- [ ] æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—® API
- [ ] æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†å‘˜ API
- [ ] å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»æ­£å¸¸
- [ ] SQL æ³¨å…¥é˜²æŠ¤æ­£å¸¸

### æ€§èƒ½æµ‹è¯•
- [ ] å¤§é‡æ•°æ®æŸ¥è¯¢æ€§èƒ½æ­£å¸¸
- [ ] å¹¶å‘è¯·æ±‚å¤„ç†æ­£å¸¸
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸

---

**æµ‹è¯•è´Ÿè´£äºº**: ___________  
**æµ‹è¯•æ—¥æœŸ**: ___________  
**æµ‹è¯•ç»“æœ**: [ ] é€šè¿‡ [ ] å¤±è´¥  
**å¤‡æ³¨**: ___________

