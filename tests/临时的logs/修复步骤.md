# Zeabur 部署问题修复步骤

## 🎯 核心问题

从日志分析发现，**环境变量 `DATABASE_URL` 的值包含了 `DATABASE_URL=` 前缀**，导致 SQLAlchemy 无法解析。

---

## ✅ 立即修复步骤

### 步骤 1：修正 DATABASE_URL 环境变量

1. **进入 Zeabur Backend 服务**
2. **点击"环境变量"标签**
3. **找到 `DATABASE_URL` 变量**
4. **点击编辑图标 ✏️**
5. **检查当前值**：
   - ❌ 如果值是：`DATABASE_URL=postgresql+asyncpg://...`
   - ✅ 应该改为：`postgresql+asyncpg://root:t0lDQTkbO3U8sjwy5A7PZ41R9Coax6c2@postgres:5432/work_permit`

6. **关键修改点：**
   - **删除 `DATABASE_URL=` 前缀**（只保留连接字符串）
   - **主机名改为 `postgres`**（服务名，不是公网地址）
   - **端口改为 `5432`**（PostgreSQL 默认端口）

7. **保存**

---

### 步骤 2：验证修复

保存后，服务会自动重启。查看日志，应该看到：

```
Waiting for database...
Running database migrations...
INFO:     Alembic upgrade head completed successfully
Starting application...
INFO:     Started server process [1]
INFO:     Application startup complete.
```

---

## 📋 正确的环境变量配置

### Backend 服务需要的环境变量：

```env
DATABASE_URL=postgresql+asyncpg://root:t0lDQTkbO3U8sjwy5A7PZ41R9Coax6c2@postgres:5432/work_permit
REDIS_URL=$REDIS.CONNECTION_STRING
CELERY_BROKER_URL=$REDIS.CONNECTION_STRING
CELERY_RESULT_BACKEND=$REDIS.CONNECTION_STRING
SECRET_KEY=work-permit-secret-key-2026-change-in-production-min-32-chars
DEBUG=false
LOG_LEVEL=INFO
APP_NAME=作业票管理系统
APP_VERSION=1.0.0
CORS_ORIGINS=["*"]
```

---

## ⚠️ 常见错误

### ❌ 错误 1：包含 KEY= 前缀
```
DATABASE_URL=postgresql+asyncpg://...
```
**正确：** 只保留连接字符串部分

### ❌ 错误 2：使用公网地址
```
postgresql+asyncpg://root:pass@sjc1.clusters.zeabur.com:29478/work_permit
```
**正确：** 使用服务名 `postgres:5432`

### ❌ 错误 3：端口错误
```
postgresql+asyncpg://root:pass@postgres:29478/work_permit
```
**正确：** 使用默认端口 `5432`

---

## 🔍 如何检查

在 Zeabur 中：
1. 进入 Backend 服务 → 环境变量
2. 点击 `DATABASE_URL` 右侧的眼睛图标 👁️
3. 查看实际值
4. 确认格式正确

---

生成时间：2026-01-11

