# 完整系统测试计划文档

## 测试概述

本文档描述了作业票管理系统的完整测试方案，涵盖后端API测试、前端UI测试和端到端集成测试。

### 测试覆盖范围

| 模块 | 后端API测试 | 前端UI测试 | 测试用例数 |
|------|-------------|------------|------------|
| 登录模块 | ✓ | ✓ | ~15 |
| Dashboard | ✓ | ✓ | ~20 |
| 作业区域 | ✓ | ✓ | ~70 |
| 培训视频 | ✓ | ✓ | ~70 |
| 施工单位 | ✓ | ✓ | ~75 |
| 人员管理 | ✓ | ✓ | ~90 |
| 用户管理 | ✓ | ✓ | ~75 |
| 报表中心 | ✓ | ✓ | ~55 |
| 告警中心 | ✓ | ✓ | ~55 |
| 系统设置 | ✓ | ✓ | ~45 |
| 集成测试 | ✓ | - | ~30 |
| **总计** | - | - | **~600** |

## 目录结构

```
tests/
├── backend/                    # 后端API测试
│   ├── __init__.py
│   ├── test_areas_api.py       # 区域管理API (30个测试)
│   ├── test_videos_api.py      # 视频管理API (30个测试)
│   ├── test_contractors_api.py # 施工单位API (35个测试)
│   ├── test_workers_api.py     # 人员管理API (40个测试)
│   ├── test_users_api.py       # 用户管理API (35个测试)
│   ├── test_reports_api.py     # 报表中心API (25个测试)
│   ├── test_alerts_api.py      # 告警中心API (25个测试)
│   └── test_settings_api.py    # 系统设置API (20个测试)
├── frontend/                   # 前端UI测试
│   ├── __init__.py
│   ├── test_login_ui.py        # 登录页面 (15个测试)
│   ├── test_dashboard_ui.py    # Dashboard (20个测试)
│   ├── test_areas_ui.py        # 区域管理 (40个测试)
│   ├── test_videos_ui.py       # 视频管理 (40个测试)
│   ├── test_contractors_ui.py  # 施工单位 (40个测试)
│   ├── test_workers_ui.py      # 人员管理 (50个测试)
│   ├── test_users_ui.py        # 用户管理 (40个测试)
│   ├── test_reports_ui.py      # 报表中心 (30个测试)
│   ├── test_alerts_ui.py       # 告警中心 (30个测试)
│   └── test_settings_ui.py     # 系统设置 (25个测试)
├── integration/                # 集成测试
│   ├── __init__.py
│   └── test_full_workflow.py   # 完整业务流程测试
├── requirements.txt            # 测试依赖
└── README.md                   # 测试说明
```

## 测试技术栈

- **后端API测试**: pytest + requests
- **前端UI测试**: pytest + playwright
- **性能测试**: locust / 自定义脚本
- **报告生成**: pytest-html, allure-pytest (可选)

## 测试环境要求

### 依赖安装

```bash
cd tests
pip install -r requirements.txt

# 安装Playwright浏览器
playwright install chromium
```

### 环境配置

测试默认配置:
- **后端地址**: http://localhost:8000
- **前端地址**: http://localhost:5173
- **测试账号**: admin / admin123

## 测试执行

### 1. 运行所有后端API测试

```bash
# 运行所有后端测试
pytest backend/ -v

# 运行单个模块测试
pytest backend/test_areas_api.py -v

# 生成HTML报告
pytest backend/ -v --html=reports/backend_report.html
```

### 2. 运行所有前端UI测试

```bash
# 确保前端服务已启动
# 运行所有前端测试
pytest frontend/ -v

# 运行单个模块测试
pytest frontend/test_login_ui.py -v

# 带截图的测试（失败时）
pytest frontend/ -v --screenshot=only-on-failure
```

### 3. 运行集成测试

```bash
# 运行完整业务流程测试
pytest integration/ -v

# 运行单个测试类
pytest integration/test_full_workflow.py::TestCompleteBusinessWorkflow -v
```

### 4. 运行全部测试

```bash
# 运行所有测试
pytest . -v

# 并行执行（需要pytest-xdist）
pytest . -v -n auto

# 生成覆盖率报告
pytest . -v --cov=../backend/app --cov-report=html
```

## 详细测试用例

### 1. 作业区域模块 (Areas)

#### 后端API测试 (test_areas_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestAreasList | test_list_basic_pagination | 基础分页查询 |
| TestAreasList | test_list_keyword_search | 关键词搜索 |
| TestAreasList | test_list_filter_by_site | 按工地筛选 |
| TestAreasList | test_list_filter_by_status | 按状态筛选 |
| TestAreasList | test_list_combined_filters | 组合筛选 |
| TestAreasList | test_list_boundary_page_zero | 边界值page=0 |
| TestAreasOptions | test_options_basic | 获取选项列表 |
| TestAreasDetail | test_detail_valid_id | 有效ID查询 |
| TestAreasDetail | test_detail_invalid_id | 无效ID处理 |
| TestAreasCreate | test_create_success_required | 必填字段创建 |
| TestAreasCreate | test_create_missing_site_id | 缺少site_id |
| TestAreasCreate | test_create_duplicate_name | 重复名称 |
| TestAreasUpdate | test_update_success | 成功更新 |
| TestAreasDelete | test_delete_success | 成功删除 |

#### 前端UI测试 (test_areas_ui.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestAreasPageLoad | test_page_loads_successfully | 页面加载 |
| TestAreasPageLoad | test_table_displayed | 表格显示 |
| TestAddAreaButton | test_add_button_opens_dialog | 打开新增对话框 |
| TestAddAreaButton | test_form_fields_displayed | 表单字段显示 |
| TestFormValidation | test_submit_without_required | 必填验证 |
| TestEditButton | test_edit_data_filled | 数据回填 |
| TestDeleteButton | test_delete_shows_confirm | 删除确认 |
| TestSearch | test_search_keyword | 关键词搜索 |
| TestPagination | test_page_change | 分页切换 |

### 2. 培训视频模块 (Videos)

#### 后端API测试 (test_videos_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestVideosList | test_list_basic_pagination | 基础分页查询 |
| TestVideosList | test_list_filter_by_category | 按分类筛选 |
| TestVideosList | test_list_filter_by_status | 按状态筛选 |
| TestVideosCreate | test_create_success_all_fields | 完整字段创建 |
| TestVideosCreate | test_create_invalid_duration | 无效时长验证 |
| TestVideosUpdate | test_update_status | 状态更新 |

#### 前端UI测试 (test_videos_ui.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestVideosPageLoad | test_duration_formatted | 时长格式化 |
| TestAddVideoButton | test_form_fields_complete | 表单完整性 |
| TestVideoFormValidation | test_url_format_validation | URL格式验证 |
| TestPreviewButton | test_preview_opens_player | 视频预览 |

### 3. 施工单位模块 (Contractors)

#### 后端API测试 (test_contractors_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestContractorsList | test_list_filter_by_qualification | 资质等级筛选 |
| TestContractorsCreate | test_create_duplicate_name | 重复名称检查 |
| TestContractorsCreate | test_create_invalid_phone | 电话格式验证 |
| TestContractorsDelete | test_delete_with_workers | 有关联数据删除 |

### 4. 人员管理模块 (Workers)

#### 后端API测试 (test_workers_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestWorkersList | test_list_filter_by_position | 按工种筛选 |
| TestWorkersCreate | test_create_duplicate_phone | 重复电话检查 |
| TestWorkersCreate | test_create_duplicate_id_no | 重复工号检查 |
| TestWorkersCreate | test_create_invalid_id_card | 身份证格式验证 |

#### 前端UI测试 (test_workers_ui.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestWorkerFormValidation | test_phone_format | 电话格式 |
| TestWorkerFormValidation | test_id_card_format | 身份证格式 |
| TestWorkerFormValidation | test_id_card_auto_fill | 自动填充 |
| TestBatchOperations | test_multi_select | 多选功能 |
| TestBatchOperations | test_batch_export | 批量导出 |
| TestImportButton | test_download_template | 下载模板 |

### 5. 用户管理模块 (Users)

#### 后端API测试 (test_users_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestUsersList | test_list_response_no_password | 不返回密码 |
| TestUsersCreate | test_create_contractor_admin | 创建施工管理员 |
| TestUsersCreate | test_create_weak_password | 弱密码验证 |
| TestUsersDelete | test_delete_self_forbidden | 禁止删除自己 |

#### 前端UI测试 (test_users_ui.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestUserFormValidation | test_password_confirmation | 密码确认 |
| TestUserFormValidation | test_role_conditional_fields | 角色条件字段 |
| TestResetPasswordButton | test_generate_random | 随机密码生成 |

### 6. 报表中心模块 (Reports)

#### 后端API测试 (test_reports_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestDashboard | test_dashboard_basic | Dashboard统计 |
| TestTrainingProgress | test_with_date_range | 日期范围查询 |
| TestExport | test_export_training_report | 导出培训报告 |
| TestExport | test_export_reconciliation | 导出对账报告 |

#### 前端UI测试 (test_reports_ui.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestFilterConditions | test_date_range_picker | 日期选择器 |
| TestTrendCharts | test_chart_rendered | 图表渲染 |
| TestTrendCharts | test_time_dimension_switch | 时间维度切换 |
| TestExportButton | test_export_click | 导出功能 |

### 7. 告警中心模块 (Alerts)

#### 后端API测试 (test_alerts_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestAlertsStats | test_stats_by_priority | 按优先级统计 |
| TestAlertsList | test_list_filter_by_status | 状态筛选 |
| TestAlertsAcknowledge | test_acknowledge_success | 确认告警 |
| TestAlertsResolve | test_resolve_missing_resolution | 缺少处理说明 |
| TestAlertsBatch | test_batch_acknowledge | 批量确认 |

#### 前端UI测试 (test_alerts_ui.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestAlertsPageLoad | test_priority_tags_color | 优先级颜色 |
| TestAcknowledgeButton | test_acknowledge_with_note | 带备注确认 |
| TestBatchOperations | test_batch_resolve_button | 批量解决 |
| TestAutoRefresh | test_auto_refresh | 自动刷新 |

### 8. 系统设置模块 (Settings)

#### 后端API测试 (test_settings_api.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestSystemConfig | test_get_by_category | 分类获取配置 |
| TestAccessConfig | test_test_connection | 测试连接 |
| TestNotificationConfig | test_send_test_sms | 发送测试短信 |
| TestSecurityConfig | test_update_password_policy | 密码策略更新 |

#### 前端UI测试 (test_settings_ui.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestBasicSettings | test_logo_upload | Logo上传 |
| TestAccessConfig | test_connection_button | 测试连接按钮 |
| TestSecuritySettings | test_ip_whitelist | IP白名单 |

### 9. 集成测试

#### 完整业务流程 (test_full_workflow.py)

| 测试类 | 测试方法 | 测试内容 |
|--------|----------|----------|
| TestCompleteBusinessWorkflow | test_complete_workflow | 完整业务流程 |
| TestCrossModuleDataFlow | test_contractor_worker_relationship | 施工单位-工人关系 |
| TestCrossModuleDataFlow | test_site_data_isolation | 工地数据隔离 |
| TestPermissionValidation | test_sysadmin_full_access | 管理员权限 |
| TestPermissionValidation | test_invalid_token_rejected | 无效token拒绝 |
| TestDataIntegrity | test_unique_constraints | 唯一性约束 |
| TestErrorHandling | test_404_not_found | 404处理 |
| TestErrorHandling | test_422_validation_error | 422处理 |

## 测试报告

### 生成测试报告

```bash
# HTML报告
pytest . -v --html=reports/test_report.html --self-contained-html

# Allure报告（需安装allure-pytest）
pytest . -v --alluredir=reports/allure-results
allure serve reports/allure-results
```

### 测试覆盖率

```bash
# 生成覆盖率报告
pytest . -v --cov=../backend/app --cov-report=html:reports/coverage

# 查看报告
open reports/coverage/index.html
```

## CI/CD集成

### GitHub Actions配置示例

```yaml
name: Test Suite

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r tests/requirements.txt
        playwright install chromium
    
    - name: Run backend tests
      run: pytest tests/backend/ -v
    
    - name: Run integration tests
      run: pytest tests/integration/ -v
```

## 测试最佳实践

### 1. 测试数据管理
- 每个测试创建自己的测试数据
- 测试结束后清理创建的数据
- 使用唯一标识避免数据冲突

### 2. 测试隔离
- 每个测试独立运行
- 不依赖其他测试的执行顺序
- 使用fixture管理共享资源

### 3. 断言规范
- 每个测试只验证一个功能点
- 使用明确的断言消息
- 验证状态码和业务返回码

### 4. 错误处理
- 测试边界条件
- 测试异常情况
- 验证错误消息

## 常见问题

### Q1: 前端测试失败，提示找不到元素
A: 检查选择器是否正确，可能需要等待元素加载。使用`page.wait_for_selector()`。

### Q2: 后端测试返回401
A: 检查token是否正确获取，确保登录接口正常工作。

### Q3: 测试运行缓慢
A: 使用pytest-xdist并行执行: `pytest -n auto`

### Q4: 数据库数据不一致
A: 确保每个测试清理自己创建的数据，使用事务回滚或fixture清理。

